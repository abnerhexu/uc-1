# å¹¶è¡Œç¼–ç¨‹å…¥é—¨

ä¹‹å‰æˆ‘ä»¬ç¼–å†™çš„ç¨‹åºï¼Œä¸€èˆ¬æ¥è¯´éƒ½æ˜¯å•çº¿ç¨‹ä¸²è¡Œè¿è¡Œçš„ã€‚è¦æƒ³è¿›ä¸€æ­¥æé«˜è¿è¡Œé€Ÿåº¦ï¼Œç›´è§‰ä¸Šæˆ‘ä»¬èƒ½å¤Ÿæƒ³åˆ°çš„å°±æ˜¯å°†ä¸€ä¸ªé—®é¢˜æ‹†åˆ†ä¸ºè¾ƒå°çš„å‡ éƒ¨åˆ†ï¼Œç„¶åè¿™å‡ éƒ¨åˆ†è¦æ˜¯èƒ½å¤ŸåŒæ­¥æ‰§è¡Œå°±å¥½äº†ã€‚æ¯å¹´çš„6æœˆå’Œ11æœˆï¼Œtop500.orgçš„ç½‘ç«™ä¸Šéƒ½ä¼šå‘å¸ƒå…¨ä¸–ç•Œçš„è¶…çº§è®¡ç®—æœºæœ€æ–°æ’åï¼›è€Œå¯¹äºè¿™äº›è¶…çº§è®¡ç®—æœºæ€§èƒ½çš„è¯„å®šæ–¹å¼ï¼Œæ˜¯é€šè¿‡è¿è¡Œä¸€ä¸ªåŸºå‡†æµ‹è¯•ç¨‹åºï¼Œè€Œè¿™ä¸ªåŸºå‡†æµ‹è¯•ç¨‹åºåœ¨è¶…çº§è®¡ç®—æœºä¸Šçš„è¿è¡Œï¼Œæ­£æ˜¯å’Œæˆ‘ä»¬ç›´è§‰ä¸Šè®¤ä¸ºçš„ä¸€æ ·ï¼Œå°†ä¸€ä¸ªè¶…å¤§çš„çŸ©é˜µè¿ç®—åˆ†è§£ä¸ºè¾ƒå°çš„è‹¥å¹²éƒ¨åˆ†ï¼Œç„¶ååˆ†åˆ«åœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸­è¿›è¡Œè®¡ç®—ã€‚åœ¨æœ¬ç« ä¸­æˆ‘ä»¬åªäº†è§£å¹¶è¡Œç¼–ç¨‹æœ€åŸºæœ¬çš„æ¦‚å¿µï¼Œç„¶åä½“éªŒä¸€ç•ªå¹¶è¡Œè®¡ç®—çš„æ•ˆæœã€‚

### 7.1 è®¤è¯†å¹¶è¡Œè®¡ç®—

å†å²ä¸Šï¼Œä¸ºäº†æé«˜è®¡ç®—æœºçš„è®¡ç®—èƒ½åŠ›ï¼Œäººä»¬æƒ³è¿‡å¯ä»¥é€šè¿‡æé«˜å¤„ç†å™¨çš„é¢‘ç‡ï¼Œè¿™æ ·æ‰§è¡Œä¸€æ¡æŒ‡ä»¤æ‰€éœ€è¦çš„æ—¶é—´å°±æ›´çŸ­ã€‚ç„¶è€Œåœ¨å¤„ç†å™¨çš„å‘å±•è¿‡ç¨‹ä¸­ï¼ŒåŠŸè€—å’Œæ•£çƒ­æˆä¸ºäº†å·¨å¤§çš„ç“¶é¢ˆï¼Œç”±äºæ— æ³•å…‹æœè¿™äº›éšœç¢ï¼Œäººä»¬æ‰è¢«è¿«èµ°ä¸Šäº†å¤šæ ¸å¿ƒçš„é“è·¯ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸€å—èŠ¯ç‰‡ä¸Šæ”¾ç½®å¤šä¸ªå¤„ç†å™¨ã€‚ç°åœ¨ï¼Œå®¶ç”¨çš„ä¸ªäººè®¡ç®—æœºä¸€èˆ¬éƒ½æ˜¯å…­æ ¸æˆ–å…«æ ¸ï¼›åœ¨ç§»åŠ¨å¤„ç†å™¨é¢†åŸŸï¼ŒSnapdragon 888 Gen1ä¹Ÿå·²ç»è¾¾åˆ°äº†8æ ¸ï¼ˆå¹¶ä¸”å…·æœ‰è¶…å¤§æ ¸ã€å¤§æ ¸å’Œå°æ ¸ä¹‹åˆ†ï¼‰ï¼›æ—¢è¢«ç”¨åœ¨æ¡Œé¢ç«¯ä¹Ÿè¢«ç”¨åœ¨ç§»åŠ¨ç«¯çš„Apple M1èŠ¯ç‰‡ä¹Ÿå…·æœ‰8æ ¸å¿ƒï¼ˆå…¶ä¸­4ä¸ªé«˜æ€§èƒ½å¤§æ ¸å¿ƒå’Œ4ä¸ªé«˜æ•ˆèƒ½å°æ ¸å¿ƒï¼‰ã€‚æ€»ä¹‹ï¼Œç°ä»£è®¡ç®—æœºå‡ ä¹éƒ½æ˜¯ç”±å¤šæ ¸ã€å¼‚æ„çš„è®¡ç®—å•å…ƒç»„æˆçš„ã€‚

å› æ­¤ï¼Œä¸ºäº†å……åˆ†åˆ©ç”¨å¥½å…¨éƒ¨çš„è®¡ç®—èµ„æºï¼Œå¹¶è¡Œè®¡ç®—å°±æ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚é€šè¿‡åœ¨ä¸åŒçš„æ ¸å¿ƒä¸Šå¤„ç†æˆ‘ä»¬åˆ†è§£çš„å°ä»»åŠ¡ï¼Œå°±ç›¸å½“äºæ˜¯ç”±ä¸€ä¸ªäººç§»å±±å˜æˆäº†å¤šä¸ªäººç§»å±±ï¼Œæ„šå…¬çš„æ„¿æœ›å°±èƒ½å®ç°å¾—æ›´å¿«äº†ã€‚

ä¸‹é¢æˆ‘ä»¬ä»‹ç»ä¸¤ä¸ªæœ€åŸºæœ¬çš„æ¦‚å¿µï¼šè¿›ç¨‹å’Œçº¿ç¨‹ã€‚

#### 7.1.1 è¿›ç¨‹ä¸çº¿ç¨‹

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ã€‚

```c
#include <stdio.h>
int main(){
  printf("Hello, world!\n");
  return 0;
}
```

è¿™ä¸€æ®µä»£ç å¯ä»¥ç”±å‘½ä»¤gcc hello.c -o helloç¼–è¯‘ä¸ºæ–‡ä»¶åä¸ºhelloçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚åƒè¿™æ ·çš„æ–‡ä»¶åœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œæ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæä¾›ä¸€ç§å‡è±¡ï¼Œå¥½åƒç³»ç»Ÿä¸Šåªæœ‰è¿™ä¸ªç¨‹åºåœ¨è¿è¡Œã€‚ç¨‹åºçœ‹ä¸Šå»æ˜¯ç‹¬å åœ°ä½¿ç”¨å¤„ç†å™¨ã€ä¸»å­˜å’ŒIOè®¾å¤‡ï¼›å¤„ç†å™¨çœ‹ä¸Šå»å°±åƒæ˜¯åœ¨ä¸€æ¡æ¥ä¸€æ¡åœ°æ‰§è¡Œç¨‹åºä¸­çš„æŒ‡ä»¤â€”â€”è¿™ä¸ªå‡è±¡æ˜¯é€šè¿‡**è¿›ç¨‹**è¿™ä¸€æŠ½è±¡æ¦‚å¿µæ¥å®ç°çš„ï¼Œè€Œå¹¶å‘è¿è¡Œåˆ™æ˜¯æŒ‡ä¸åŒè¿›ç¨‹ä¹‹é—´çš„æŒ‡ä»¤åœ¨å¤„ç†å™¨ä¸Šäº¤é”™è¿è¡Œã€‚

å¯¹äºä¸€ä¸ªå•å¤„ç†å™¨çš„ç³»ç»Ÿï¼Œåœ¨ä»»ä½•æ—¶åˆ»å®ƒéƒ½åªèƒ½å¤„ç†ä¸€ä¸ªè¿›ç¨‹çš„ä»£ç ã€‚äºæ˜¯ï¼Œéœ€è¦ä¾é æ“ä½œç³»ç»Ÿæ¥å°†æ§åˆ¶æƒä»ä¸€ä¸ªè¿›ç¨‹åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ã€‚åœ¨åˆ‡æ¢ä¹‹å‰ï¼Œæ“ä½œç³»ç»Ÿéœ€è¦ä¿å­˜è¿™ä¸ªè¿›ç¨‹çš„å…¨éƒ¨çŠ¶æ€ï¼ˆè¢«ç§°ä½œ**ä¸Šä¸‹æ–‡**ï¼‰ï¼Œå½“æ§åˆ¶æƒåˆ‡æ¢å›å…ˆå‰çš„ç¨‹åºæ—¶ï¼Œè¿›ç¨‹å°±ä¼šä»å®ƒä¸Šæ¬¡åœæ­¢çš„åœ°æ–¹ç»§ç»­è¿è¡Œã€‚

åœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹å®é™…ä¸Šå¯ä»¥ç”±å¤šä¸ªæ‰§è¡Œå•å…ƒç»„æˆï¼Œæ¯ä¸€ä¸ªæ‰§è¡Œå•å…ƒè¢«ç§°ä¸º**çº¿ç¨‹**ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½è¿è¡Œåœ¨è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶å…±äº«åŒæ ·çš„ä»£ç å’Œå…¨å±€æ•°æ®ã€‚ä¾‹å¦‚ï¼ŒPyPyä¸­çš„threadingåº“ä¸ºæˆ‘ä»¬æä¾›äº†éªŒè¯çº¿ç¨‹å…±äº«å…¨å±€æ•°æ®çš„æ–¹æ³•ã€‚æ³¨æ„ï¼ŒPythonå…·æœ‰çš„å…¨å±€è§£é‡Šå™¨é”ï¼ˆGILï¼‰ä½¿å¾—æˆ‘ä»¬æ¥ä¸‹æ¥çš„ä»£ç æ— æ³•åœ¨æœ€å¹¿æ³›ä½¿ç”¨çš„CPythonè§£é‡Šå™¨ä¸Šè¿è¡Œï¼Œæ¥ä¸‹æ¥çš„ä»£ç æˆ‘ä»¬éƒ½ç”¨PyPyè§£é‡Šå™¨æ¥è¿è¡Œã€‚

```python
from threading import Thread
import time

var = 0

def th1():
    global var
    var += 1

def th2():
    global var
    var += 1

def main():
    global var
    t1 = Thread(target=th1)
    t1.start()
    time.sleep(1)
    t2 = Thread(target=th2)
    t2.start()
    time.sleep(1)
    print(var)

main()
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œå…¶ä½œç”¨éƒ½æ˜¯å°†å…¨å±€å˜é‡varåŠ 1ã€‚ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæˆä»¥åï¼Œå˜é‡varçš„å€¼ä»0å˜æˆäº†2ã€‚

#### 7.1.2 å¹¶å‘ä¸å¹¶è¡Œ å¹¶è¡Œç¼–ç¨‹æ¨¡å‹

å¹¶å‘æ˜¯ä¸€ä¸ªé€šç”¨çš„æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯åŒä¸€ä¸ªç³»ç»Ÿèƒ½åœ¨åŒä¸€æ—¶åˆ»æ‰§è¡Œæ›´å¤šå·¥ä½œï¼Œè€Œå¹¶è¡Œæ˜¯æŒ‡ç”¨å¹¶å‘æ¥ä½¿ä¸€ä¸ªç³»ç»Ÿè¿è¡Œå¾—æ›´å¿«ã€‚

å¹¶è¡Œç¼–ç¨‹æ¨¡å‹åˆ™æ˜¯å¯¹ç¡¬ä»¶å’Œå†…å­˜æ¶æ„çš„æŠ½è±¡ã€‚é€šå¸¸æ¥è¯´ï¼Œå¹¿æ³›ä½¿ç”¨çš„æ¨¡å‹æœ‰å…±äº«å†…å­˜æ¨¡å‹ã€å¤šçº¿ç¨‹æ¨¡å‹ã€åˆ†å¸ƒå¼å†…å­˜æ¨¡å‹/æ¶ˆæ¯ä¼ é€’æ¨¡å‹ã€æ•°æ®å¹¶è¡Œæ¨¡å‹ã€‚

åœ¨å…±äº«å†…å­˜æ¨¡å‹ä¸­ï¼Œæ‰€æœ‰ä»»åŠ¡å…±äº«ä¸€ä¸ªå†…å­˜ç©ºé—´ï¼Œå› è€Œä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œç³»ç»Ÿéœ€è¦æä¾›ä¸€äº›ç‰¹æ®Šçš„æœºåˆ¶æ¥æ§åˆ¶å…±äº«å†…å­˜çš„è®¿é—®æƒé™ï¼Œä¾‹å¦‚ä¿¡å·é‡å’Œé”æœºåˆ¶ã€‚è¿™è¿›è¡Œäº†è¿›ä¸€æ­¥çš„æŠ½è±¡ï¼Œå› è€Œæˆ‘ä»¬æ— éœ€å…³å¿ƒä»»åŠ¡ä¹‹é—´æ˜¯å¦‚ä½•åˆ‡æ¢å’Œé€šä¿¡çš„ï¼›ç¼ºç‚¹åœ¨äºè¿™ä¸ªæ¨¡å‹å­˜åœ¨çš„æ€§èƒ½å¼€é”€ã€‚

åœ¨å¤šçº¿ç¨‹æ¨¡å‹ä¸­ï¼Œå•ä¸ªå¤„ç†å™¨å¯ä»¥æœ‰å¤šä¸ªæ‰§è¡Œæµã€‚ç”±äºä¸åŒçš„çº¿ç¨‹å¯èƒ½ä¼šå¯¹å…±äº«å†…å­˜è¿›è¡Œæ“ä½œï¼Œå› æ­¤çº¿ç¨‹é—´çš„é€šä¿¡éå¸¸é‡è¦ï¼›å¿…é¡»è¦é˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹ç›¸åŒçš„å†…å­˜å•å…ƒï¼Œå¦åˆ™ä¼šé€ æˆæ„æƒ³ä¸åˆ°çš„é”™è¯¯ã€‚POSIXæ˜¯å…¸å‹çš„ç”¨è½¯ä»¶æ¥å®ç°å¤šçº¿ç¨‹æ¨¡å‹çš„æ¡ˆä¾‹ï¼›Intelå¤„ç†å™¨å…·æœ‰çš„è¶…çº¿ç¨‹åˆ™æ˜¯é€šè¿‡ç¡¬ä»¶å®ç°å¤šçº¿ç¨‹æ¨¡å‹ï¼Œå®ƒæ˜¯åŸºäºCPUä¸­æŸäº›éƒ¨ä»¶å…·æœ‰å¤‡ä»½ï¼Œå› æ­¤å¦‚æœæŸä¸€çº¿ç¨‹éœ€è¦å…ˆå°†æ•°æ®è½½å…¥è¿›é«˜é€Ÿç¼“å­˜ï¼Œé‚£ä¹ˆCPUå°±å¯ä»¥å…ˆå»æ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹ã€‚

æ¶ˆæ¯ä¼ é€’æ¨¡å‹å®è´¨ä¸Šæ˜¯é¢å‘åˆ†å¸ƒå¼å†…å­˜çš„å¹¶è¡Œæ¨¡å‹ã€‚å‡è‹¥æˆ‘ä»¬æœ‰å‡ å°ä¸åŒçš„è®¾å¤‡ï¼Œé‚£ä¹ˆè®¾å¤‡ä¹‹é—´çº¿é€šä¿¡å°±å¯¹è®¾å¤‡é—´çš„å¹¶è¡Œååˆ†é‡è¦ã€‚æœ€å¹¿æ³›åº”ç”¨çš„æ ‡å‡†æ˜¯MPI(Message Passing Interface)æ¨¡å‹ï¼Œåœ¨Pythonä¸­æœ‰mpi4pyè¿™ä¸ªåº“å¯ä¾›æˆ‘ä»¬è°ƒç”¨ã€‚

æ•°æ®å¹¶è¡Œæ¨¡å‹ç›¸å¯¹å¥½ç†è§£ä¸€äº›ã€‚åœ¨ç›¸åŒçš„ä»»åŠ¡ä¸­ï¼Œå¯¹ä¸åŒçš„æ•°æ®è¿›è¡Œæ“ä½œï¼Œä¸åŒçš„æ•°æ®è¢«åˆ†éš”åœ¨å±€éƒ¨å†…å­˜ä¸­ï¼Œæœ€å…¸å‹çš„æ¡ˆä¾‹å°±æ˜¯GPUã€‚

### 7.2 åŸºäºçº¿ç¨‹çš„å¹¶è¡Œ

PyPyå…·æœ‰çº¿ç¨‹æ ‡å‡†åº“threadingï¼Œèƒ½å¤Ÿè¿›è¡Œæ›´é«˜æ ‡å‡†çš„çº¿ç¨‹ç®¡ç†ï¼ˆç›¸è¾ƒäºthreadåº“ï¼‰ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬éƒ½ä½¿ç”¨è¿™ä¸ªåº“æ¥å®ç°åŸºäºçº¿ç¨‹çš„å¹¶è¡Œã€‚

#### 7.2.1 åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ å¹¶å‘ç¼–ç¨‹çš„å±é™©

threadingåº“å°†çº¿ç¨‹è§†ä½œä¸€ä¸ªå¯¹è±¡ã€‚è¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”ä½¿ç”¨start()æ–¹æ³•å¯åŠ¨å®ƒã€‚æˆ‘ä»¬å…ˆæ¥è€ƒå¯Ÿä¸€ä¸‹å®ä¾‹åŒ–å¯¹è±¡éœ€è¦ä¼ å…¥çš„å‚æ•°ã€‚

```python
class threading.Thread(group=None,
                       target=None,
                       name=None,
                       args=(),
                       kwargs={})
```

groupæ˜¯ä¿ç•™å‚æ•°ï¼Œæš‚æ—¶ä¸éœ€è¦çŸ¥é“å…¶å«ä¹‰ï¼›targetæ˜¯æˆ‘ä»¬è¦æ‰§è¡Œçš„å‡½æ•°ï¼›nameæ˜¯åˆ›å»ºçš„çº¿ç¨‹çš„åå­—ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œé»˜è®¤ä¼šåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„åå­—Thread-Nï¼›argsæ˜¯ä¼ å…¥ç»™çº¿ç¨‹çš„å‚æ•°ï¼Œä½¿ç”¨tupleç±»å‹ï¼›kwargsåˆ™æ˜¯ä¼ å…¥å‚æ•°åå’Œå‚æ•°å€¼å¯¹åº”çš„å­—å…¸ç±»å‹ã€‚æ³¨æ„ï¼Œargså‚æ•°éœ€è¦ä¼ å…¥ä¸€ä¸ªå¯è¿­ä»£çš„å¯¹è±¡ï¼Œå¦‚æœå†™ä¸ºargs=(i)å°±ä¼šæŠ¥é”™ã€‚

```python
from threading import Thread
import time
import numpy as np

def work(i):
    time.sleep(np.random.rand())
    print("thread number:", i)
    
ts = []
for i in range(3):
    t = Thread(target=work, args=(i,))
    ts.append(t)
    t.start()
```

ä¸€åˆ‡éƒ½è¿˜å¾ˆé¡ºåˆ©ï¼Œæˆ‘ä»¬ä¼¼ä¹å·²ç»å¯ä»¥åŒæ—¶æœ‰å¤šä¸ªçº¿ç¨‹å·¥ä½œäº†ã€‚ä½†æ˜¯ï¼Œå¹¶å‘ç¼–ç¨‹å¾€å¾€ä¸ºæˆ‘ä»¬å¸¦æ¥æ— ç©·æ— å°½çš„éº»çƒ¦ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å¯¹æŸä¸ªå…¨å±€å˜é‡æ‰§è¡Œè‡ªå¢æ“ä½œï¼Œé‚£ä¹ˆå…¨å±€å˜é‡ä¼šæ€æ ·å˜åŒ–å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ã€‚

```python
import threading
ans = 0

def addnum():
    global ans
    for i in range(10000000):
        ans += 1


t0 = threading.Thread(target=addnum)
t1 = threading.Thread(target=addnum)
t2 = threading.Thread(target=addnum)
t0.start()
t1.start()
t2.start()
t0.join()
t1.join()
t2.join()
print(ans)
```

ä¸Šé¢çš„ä»£ç å¾—åˆ°çš„ç»“æœå¯èƒ½æ˜¯æ­£ç¡®çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯é”™è¯¯çš„ï¼Œä¾‹å¦‚29474154ã€‚

![](image/image_pdsvS_d4Iz.png)

å‡ºç°è¿™ç§ç°è±¡çš„åŸå› åœ¨äºï¼Œå¯èƒ½æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è¯»å–äº†åŒä¸€ä¸ªå†…å­˜åœ°å€ï¼Œåœ¨è¿›è¡Œäº†åŠ æ³•è¿ç®—ååˆåˆ†åˆ«å†™å›ã€‚è¿™æ ·ï¼Œå¾—åˆ°çš„ç»“æœå°±ä¼šå°äºæˆ‘ä»¬é¢„æœŸçš„ç»“æœã€‚æ›´æ·±å±‚æ¬¡çš„åŸå› åœ¨äºï¼Œå¯¹äºç°ä»£å¤šæ ¸å¿ƒå¤„ç†å™¨è€Œè¨€ï¼Œâ€œç¨‹åºçš„æŒ‡ä»¤ç‹¬å æ•´ä¸ªå¤„ç†å™¨æ‰§è¡Œâ€ä¸å†æˆç«‹ã€‚å¯¹äºä¸€ä¸ªå•å¤„ç†å™¨ç³»ç»Ÿè€Œè¨€ï¼Œå¯èƒ½æŸä¸€æ—¶åˆ»çº¿ç¨‹çš„è¿è¡Œä¼šä¸­æ–­ï¼Œç„¶åç³»ç»Ÿåˆ‡æ¢åˆ°å¦ä¸€çº¿ç¨‹è¿è¡Œï¼›è€Œå¯¹äºå¤šå¤„ç†å™¨ç³»ç»Ÿï¼ŒæŒ‡ä»¤çš„æ‰§è¡Œæœ¬æ¥å°±æ˜¯å¹¶è¡Œçš„ã€‚æœ‰å…³è¿™æ–¹é¢çš„æ›´å¤šçš„å†…å®¹ï¼Œæˆ‘ä»¬ä¼šåœ¨ã€Šæ“ä½œç³»ç»Ÿã€‹è¿™é—¨è¯¾ç»§ç»­ä»‹ç»ã€‚

æ€è€ƒé¢˜ä¸­ï¼Œæˆ‘ä»¬è¿˜ç•™ä¸‹äº†ä¸€ä¸ªåŠå¼€æ”¾çš„é—®é¢˜ï¼Œæœ‰å…³å¹¶å‘ç¼–ç¨‹ä¸ç¬¦åˆæˆ‘ä»¬é¢„æœŸçš„ç»“æœã€‚

#### 7.2.2 ä½¿ç”¨Lockè¿›è¡Œçº¿ç¨‹åŒæ­¥

ç°åœ¨æˆ‘ä»¬èƒ½å€ŸåŠ©threadingåº“å®ç°ä¸€ä¸ªæœ€é‡è¦çš„äº‹æƒ…ï¼šåŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®å…±äº«å˜é‡ã€‚åŸºæœ¬çš„æ€è·¯æ˜¯ï¼Œä¸ºäº†è®¿é—®å…±äº«å˜é‡ï¼Œçº¿ç¨‹å¿…é¡»å…ˆè·å¾—é”ï¼Œä½¿ç”¨å®Œååˆå¿…é¡»é‡Šæ”¾é”ï¼›è€Œçº¿ç¨‹è·å¾—é”å’Œé‡Šæ”¾é”çš„è¿‡ç¨‹æ˜¯**åŸå­æ“ä½œ**ï¼Œå³é€šè¿‡æ›´ä¸ºåº•å±‚çš„è½¯ä»¶æˆ–ç¡¬ä»¶çš„æ–¹æ³•ç¡®ä¿æ¯ä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è·å–æˆ–è€…é‡Šæ”¾é”ã€‚

æˆ‘ä»¬å®šä¹‰ä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å¯¹å…¨å±€å…±äº«å˜é‡åŠ 1ï¼Œå¦ä¸€ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å¯¹å…¨å±€å…±äº«å˜é‡å‡1ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½å®ç°è¿™ä¸¤ä¸ªå‡½æ•°çš„äº¤æ›¿æ‰§è¡Œï¼ˆå› ä¸ºæŸä¸ªçº¿ç¨‹åœ¨ç¬¬äºŒæ¬¡è·å¾—é”ä¹‹å‰ï¼Œå¿…é¡»å…ˆé‡Šæ”¾é”ï¼Œè¿™æ ·å¦ä¸€ä¸ªçº¿ç¨‹å°±è·å¾—é”äº†ï¼‰

```python
import threading
lock = threading.Lock()
var = 0

def locked_inc():
    global var
    for i in range(10000):
        lock.acquire()
        var += 1
        lock.release()

def locked_dec():
    global var
    for i in range(10000):
        lock.acquire()
        var -= 1
        lock.release()

def main():
    global var
    t1 = threading.Thread(target=locked_inc)
    t2 = threading.Thread(target=locked_dec)
    t1.start()
    t2.start()
    t1.join()
    t2.join()
    print("var:", var)

main()
```

å¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸åŠ é”çš„ç‰ˆæœ¬ï¼Œé‚£ä¹ˆæƒ…å†µæ˜¯

```python
import threading
var = 100

def locked_inc():
    global var
    for i in range(10000):
        var += 1

def locked_dec():
    global var
    for i in range(10000):
        var -= 1

def main():
    global var
    t1 = threading.Thread(target=locked_inc)
    t2 = threading.Thread(target=locked_dec)
    t1.start()
    t2.start()
    t1.join()
    t2.join()
    print("var:", var)
main()
```

å¯èƒ½æŸä¸€æ¬¡è¾“å‡ºçš„ç»“æœæ˜¯ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸçš„ï¼Œä½†å¤šè¿è¡Œå‡ æ¬¡å°±ä¼šå‡ºç°å…¶ä»–è¶…ä¹æˆ‘ä»¬æƒ³è±¡çš„ç»“æœã€‚

ç†è®ºä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ä¸€ä¸ªæœ€åŸºæœ¬çš„ä½¿ç”¨é”è¿›è¡ŒåŒæ­¥çš„ç¨‹åºäº†ï¼Œä½†æ˜¯ï¼Œé”çš„ä½¿ç”¨å¾€å¾€è¿˜ä¼šå¸¦æ¥ä¸€äº›å…¶ä»–é—®é¢˜ï¼Œä¾‹å¦‚æ­»é”å’Œä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä»‹ç»å…¶ä»–çš„æ–¹æ¡ˆã€‚

#### 7.2.3 ä¿¡å·é‡ ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ å“²å­¦å®¶åƒé¥­

ä¿¡å·é‡æ˜¯ä¸€ç§æŠ½è±¡çš„æ•°æ®ç±»å‹ï¼Œå®ƒçš„æœºåˆ¶æ˜¯ï¼Œä¿¡å·é‡é€šå¸¸æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œç”¨æ¥è¡¨æ˜ç³»ç»Ÿä¸­æœ‰å¤šå°‘å…±äº«èµ„æºå¯ä»¥è¢«è°ƒç”¨ã€‚å¦‚æœå¯ä»¥è¢«è°ƒç”¨çš„èµ„æºæ•°ä¸º0ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°±è¢«æŒ‚èµ·ï¼›åä¹‹åˆ™å…è®¸ä½¿ç”¨å…±äº«èµ„æºã€‚åœ¨threadingåº“ä¸­ï¼Œä¿¡å·é‡çš„æ“ä½œåŒæ ·åŒ…å«acquire()å’Œrelease()ã€‚è€ƒè™‘ä¸‹é¢è¿™ç§æƒ…å½¢ã€‚

> ğŸˆç°åœ¨æœ‰ä¸€ä¸ªç¯®å­ï¼Œç¯®å­æœ€å¤šèƒ½æ”¾ä¸‹$n$ä¸ªé¢åŒ…ï¼›æœ€å¼€å§‹ç¯®å­é‡Œé¢æ²¡æœ‰è›‹ç³•ã€‚ç”Ÿäº§çº¿è´Ÿè´£ç”Ÿäº§é¢åŒ…å¹¶å°†å…¶æ”¾å…¥ç¯®å­ä¸­ï¼Œé”€å”®äººå‘˜è´Ÿè´£å°†é¢åŒ…ä»ç¯®å­ä¸­æ‹¿èµ°ã€‚å½“ç¯®å­ä¸­é¢åŒ…æ•°ä¸º0æ—¶ï¼Œé”€å”®äººå‘˜ä¸èƒ½å†æ‹¿èµ°é¢åŒ…ï¼›å½“ç¯®å­ä¸­é¢åŒ…æ•°ä¸º$n$æ—¶ï¼Œç”Ÿäº§çº¿ä¸èƒ½ç»§ç»­ç”Ÿäº§é¢åŒ…ã€‚

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¯ä»¥è®¾è®¡ä¸¤ä¸ªä¿¡å·é‡ã€‚ç¬¬ä¸€ä¸ªä¿¡å·é‡emptyåˆå§‹å€¼ä¸º5ï¼Œç¬¬äºŒä¸ªä¿¡å·é‡fullåˆå§‹å€¼ä¸º0ã€‚æ¯æ”¾å…¥1ä¸ªé¢åŒ…ï¼Œemptyè‡ªå‡1ï¼Œfullè‡ªå¢1ï¼›æ¯æ‹¿èµ°ä¸€ä¸ªé¢åŒ…ï¼Œfullè‡ªå‡1ï¼Œemptyè‡ªå¢1ã€‚æœ€åï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¬¬ä¸‰ä¸ªä¿¡å·é‡mutexæ¥ä¿è¯ç”Ÿäº§çº¿ä¸é”€å”®äººå‘˜å¯¹äºç¯®å­çš„æ”¾/å–æ“ä½œäº’æ–¥ã€‚ç”¨ä»£ç å®ç°å°±æ˜¯

```python
import threading

lock = threading.Lock()
empty = threading.Semaphore(5)
full = threading.Semaphore(0)
buffer = 0

def producer():
    global buffer
    for i in range(20):
        empty.acquire()
        lock.acquire()
        buffer += 1
        print("buffer + 1, buffer = %d" % buffer)
        lock.release()
        full.release()

def consumer():
    global buffer
    for j in range(20):
        full.acquire()
        lock.acquire()
        buffer -= 1
        print("buffer - 1, buffer = %d" % buffer)
        lock.release()
        empty.release()

def main():
    global buffer
    t1 = threading.Thread(target=producer)
    t2 = threading.Thread(target=consumer)
    t1.start()
    t2.start()
    t1.join()
    t2.join()
    print("buffer:", buffer)

main()
```

è¿™å°±æ˜¯è‘—åçš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼›åº”å½“è¯´ç»å¤§å¤šæ•°å®é™…çš„å¹¶å‘æ¨¡å‹éƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¨¡å‹æ¥å¤„ç†ã€‚åˆå­¦è€…å¸¸å¸¸æœ‰è¿™æ ·çš„ç–‘é—®ï¼Œåªç”¨ä¸€ä¸ªä¿¡å·é‡è¡Œä¸è¡Œï¼Ÿè€Œä¸”è¿˜å¯ä»¥å†™å‡ºä¸‹é¢è¿™æ ·çš„ä»£ç ã€‚

```python
import threading
buffer = 0
sig = threading.Semaphore(5)
mutex = threading.Lock()

def producer():
    global buffer
    for i in range(20):
        mutex.acquire()
        sig.acquire()
        buffer += 1
        print("buffer + 1, buffer = %d" % buffer)
        mutex.release()

def consumer():
    global buffer
    for j in range(20):
        mutex.acquire()
        sig.release()
        buffer -= 1
        print("buffer - 1, buffer = %d" % buffer)
        mutex.release()

def main():
    global buffer
    t1 = threading.Thread(target=producer)
    t2 = threading.Thread(target=consumer)
    t1.start()
    t2.start()
    t1.join()
    t2.join()
    
main()

```

çœ‹ä¸Šå»å¥½åƒæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯ï¼Œproduceræ˜¯ä¸å—é™åˆ¶çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿›ç¨‹t1å¯ä»¥ä¸€ç›´å¾€ç¯®å­é‡Œé¢æ”¾é¢åŒ…ã€‚ä½¿ç”¨ä¸¤ä¸ªä¿¡å·é‡çš„åŠŸèƒ½åœ¨äºï¼Œä¸€ä¸ªä¿¡å·é‡ç”¨äºåˆ¶çº¦ç”Ÿäº§è€…ï¼Œå¦ä¸€ä¸ªä¿¡å·é‡ç”¨äºåˆ¶çº¦æ¶ˆè´¹è€…ã€‚æ‰€ä»¥ï¼Œåœ¨æ•´ä¸ªç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ°çš„æ˜¯ä¸€ä¸ªé”å’Œä¸¤ä¸ªä¿¡å·é‡ã€‚

ç°åœ¨ï¼Œä½ å¯ä»¥è‡ªè¡Œè®¾è®¡å‡ºä¸€å¥—æ–¹æ¡ˆï¼Œè§£å†³ä¸‹é¢ç”±Dijkstraæå‡ºå¹¶è§£å†³çš„å“²å­¦å®¶åƒé¥­é—®é¢˜ã€‚é¡ºå¸¦ä¸€æï¼Œä¿¡å·é‡ä¹Ÿæ˜¯ç”±E.Dijkstraå‘æ˜å¹¶ç¬¬ä¸€æ¬¡åº”ç”¨åœ¨æ“ä½œç³»ç»Ÿçš„ã€‚è¯·ä½¿ç”¨é”å’Œä¿¡å·é‡æ¥å®ç°è¿™ä¸ªè¿‡ç¨‹ã€‚

> ğŸˆäº”ä¸ªå“²å­¦å®¶å…±ç”¨ä¸€å¼ åœ†æ¡Œï¼Œåˆ†åˆ«ååœ¨å‘¨å›´çš„äº”å¼ æ¤…å­ä¸Šï¼Œåœ¨åœ†æ¡Œä¸Šæœ‰äº”ä¸ªç¢—å’Œäº”æŠŠå‰å­ï¼Œä»–ä»¬çš„ç”Ÿæ´»æ–¹å¼æ˜¯äº¤æ›¿çš„è¿›è¡Œæ€è€ƒå’Œè¿›é¤ã€‚å¹³æ—¶ï¼Œä¸€ä¸ªå“²å­¦å®¶è¿›è¡Œæ€è€ƒï¼Œé¥¥é¥¿æ—¶ä¾¿è¯•å›¾å–ç”¨å…¶å·¦å³æœ€é è¿‘ä»–çš„ç­·å­ï¼Œåªæœ‰åœ¨ä»–æ‹¿åˆ°ä¸¤åªç­·å­æ—¶æ‰èƒ½è¿›é¤ã€‚è¿›é¤å®Œæ¯•ï¼Œæ”¾ä¸‹ç­·å­ç»§ç»­æ€è€ƒã€‚

åœ¨çº¿ç¨‹çš„åŒæ­¥é—®é¢˜ä¸Šï¼Œè¿˜æœ‰å…¶ä»–ä¸€äº›å¹¿æ³›ä½¿ç”¨çš„æ–¹æ¡ˆï¼Œä¾‹å¦‚ä½¿ç”¨äº‹ä»¶ã€æ¡ä»¶å˜é‡å’Œé€’å½’é”è¿›è¡ŒåŒæ­¥ï¼›å¦‚æœæˆ‘ä»¬çš„é—®é¢˜è¾ƒä¸ºå¤æ‚ï¼Œä»¥è‡³äºæˆ‘ä»¬æ— æ³•ä½¿ç”¨è¿™äº›åŒæ­¥åŸè¯­ï¼ˆä¾‹å¦‚ä¿¡å·é‡ï¼Œæ¡ä»¶å˜é‡ï¼Œäº‹ä»¶å’Œé”ï¼‰ï¼Œæˆ‘ä»¬è¿˜èƒ½å¤Ÿä½¿ç”¨queueæ¨¡å—é€šè¿‡é˜Ÿåˆ—æ¥è§£å†³ã€‚

### 7.3 åŸºäºè¿›ç¨‹çš„å¹¶è¡Œ

#### 7.3.1 åˆ›å»ºä¸€ä¸ªè¿›ç¨‹

åˆ›å»ºä¸€ä¸ªè¿›ç¨‹éœ€è¦ä½¿ç”¨åˆ°multiprocessingåº“ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬å°±åˆ›å»ºäº†3ä¸ªè¿›ç¨‹ã€‚

```python
import multiprocessing

def hello(i):
    print ('hello from: %d' % i)

jobs = []
if __name__ == "__main__":
    for i in range(3):
        p = multiprocessing.Process(target=hello, args=(i,))
        jobs.append(p)
        p.start()
        p.join()
```

#### 7.3.2 è¿›ç¨‹ä¹‹é—´çš„åŒæ­¥

ä¸çº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ç±»ä¼¼ï¼Œè¿›ç¨‹é—´åŒæ­¥çš„åŸè¯­åŒ…æ‹¬é”ã€æ—¶é—´ã€æ¡ä»¶å˜é‡ã€ä¿¡å·é‡ã€éšœç¢ç­‰ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬åªç®€å•ä»‹ç»ä½¿ç”¨æ·»åŠ éšœç¢çš„æ–¹å¼å®ç°è¿›ç¨‹é—´çš„åŒæ­¥ã€‚

```python
import multiprocessing
import time
from datetime import datetime

def pro1():
    time.sleep(1)
    now = time.time()
    print(datetime.fromtimestamp(now))

def pro2():
    time.sleep(2)
    now = time.time()
    print(datetime.fromtimestamp(now))

if __name__ == '__main__':
    p1 = multiprocessing.Process(target=pro1)
    p2 = multiprocessing.Process(target=pro2)
    p1.start()
    p2.start()

```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œå¹¶åœ¨åˆé€‚çš„æ—¶å€™è¾“å‡ºå½“å‰æ—¶é—´ã€‚ç†è®ºä¸Šè¯´ï¼Œæˆ‘ä»¬p1å’Œp2è¾“å‡ºçš„æ—¶é—´å·®ä¼šæ˜¯1ç§’ã€‚

ä½¿ç”¨barrier()å‡½æ•°å¯ä»¥ä½¿ä¸¤ä¸ªè¿›ç¨‹åŒæ­¥ã€‚åŸºæœ¬çš„æ€è·¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå³æŸä¸€ä¸ªè¿›ç¨‹å¦‚æœè¿è¡Œè¾ƒå¿«åˆ°è¾¾äº†éšœç¢ç‚¹ï¼Œé‚£ä¹ˆå°±å‘å¦ä¸€ä¸ªè¿›ç¨‹å‘å‡ºä¿¡å·ï¼Œå¹¶ä¸”ç­‰å¾…ï¼›å½“ä¸¤ä¸ªè¿›ç¨‹éƒ½è¿è¡Œåˆ°äº†éšœç¢ç‚¹ï¼Œæ­¤æ—¶å°±å¯ä»¥äº¤æ¢æ•°æ®ï¼Œç„¶åè¶Šè¿‡éšœç¢ç‚¹ç»§ç»­è¿è¡Œã€‚

![](image/multiprocess_p2sv0_RZew.svg)

äºæ˜¯å†™æˆä»£ç å°±æ˜¯

```python
import multiprocessing
import time
from datetime import datetime

def pro1(synchronizer, serializer):
    time.sleep(1)
    synchronizer.wait()
    now = time.time()
    with serializer:
        print(datetime.fromtimestamp(now))

def pro2(synchronizer, serializer):
    time.sleep(2)
    synchronizer.wait()
    now = time.time()
    with serializer:
        print(datetime.fromtimestamp(now))

synchronizer = multiprocessing.Barrier(2)
serializer = multiprocessing.Lock()
if __name__ == '__main__':
    p1 = multiprocessing.Process(target=pro1, args=(synchronizer,serializer))
    p2 = multiprocessing.Process(target=pro2, args=(synchronizer,serializer))
    p1.start()
    p2.start()

```

æ­¤å¤„ï¼Œåœ¨ä¸¤ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬éƒ½ç”¨åˆ°äº†withæ–¹æ³•ï¼Œä»¥pro1ä¸ºä¾‹ï¼Œå®é™…ä¸Šå®ƒä»¬ç­‰åŒäº

```python
def pro1(synchronizer, serializer):
    time.sleep(1)
    synchronizer.wait()
    now = time.time()
    serializer.acquire()
    try:
        print(datetime.fromtimestamp(now))
    finally:
        serializer.release()
```

å®æ–½ä¸Šå°±æ˜¯Pythonæ”¯æŒçš„withè¯­æ³•ï¼Œåœ¨è¿™é‡Œfinallyè¯­å¥ä¸è®ºtryè¯­å¥æ˜¯å¦æ‰§è¡ŒæˆåŠŸéƒ½ä¼šæ‰§è¡Œã€‚

#### \*7.3.3 åœ¨Pythonä¸­ä½¿ç”¨MPI

é¦–å…ˆéœ€è¦å®‰è£…MPIè½¯ä»¶ï¼Œä¸€èˆ¬æ¥è¯´æœ‰openmpiæˆ–mpichï¼›ç„¶åéœ€è¦å®‰è£…mpi4pyè¿™ä¸ªåº“ï¼Œå®‰è£…æ–¹æ³•ä¸ºpip install mpi4pyã€‚

ä¸€ä¸ªæœ€ç®€å•çš„ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºã€‚

```python
from mpi4py import MPI
comm = MPI.COMM_WORLD
rank = comm.Get_rank()
print("hello world from process ", rank)
```

ç„¶åæˆ‘ä»¬åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œ

```python
mpiexec -n 5 python hello.py
```

åœ¨è¿™ä¸ªç¨‹åºä¸­ï¼Œcommæ˜¯æ‰€æœ‰ç¨‹åºçš„é›†åˆï¼›rankæ˜¯ç”±MPIåˆ†é…çš„éè´Ÿæ•°ï¼Œå…¶å€¼ä¾æ¬¡æ˜¯ä»0åˆ°æ€»è¿›ç¨‹æ•°å‡1ã€‚é€šè¿‡Get\_rank()å‡½æ•°ï¼Œèƒ½å¤Ÿè·å¾—å½“å‰è¿è¡Œçš„è¿›ç¨‹çš„ç¼–å·ã€‚

ç‚¹å¯¹ç‚¹é€šä¿¡ä½¿ç”¨send()å’Œrecv()æ–¹æ³•ï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µå±•ç¤ºäº†è¿›ç¨‹0å‘è¿›ç¨‹1å‘é€æ•°æ®å¹¶è¢«è¿›ç¨‹1æ¥æ”¶çš„å®ä¾‹ã€‚è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ˜¯é˜»å¡å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ•°æ®ä½¿ç”¨å®Œæˆå‰ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°æ‰€åœ¨çš„è¿›ç¨‹éƒ½ä¼šè¢«é˜»å¡ã€‚

```python
from mpi4py import MPI
comm = MPI.COMM_WORLD
rank = comm.rank
print("Process rank", rank)

if rank == 0:
    data = "hello from rank 0"
    destination_process = 1
    comm.send(data,dest=destination_process)
    print("sending data to process % d" % destination_process)

if rank == 1:
   data = comm.recv(source = 0)
   print("data received is = % s" % data)
```

### 7.4äººå·¥æ™ºèƒ½ä¸­çš„å¹¶è¡Œ

ä¸€èˆ¬æ¥è¯´ï¼Œæ¨åŠ¨äººå·¥æ™ºèƒ½å‘å±•çš„ä¸»è¦æ˜¯ä»¥ä¸‹ä¸‰ä¸ªå› ç´ ï¼šç®—æ³•ã€è®­ç»ƒæ•°æ®ã€ç®—åŠ›ã€‚OpenAI æå‡ºï¼Œè‡ª 2012 å¹´ä»¥æ¥ï¼Œäººå·¥æ™ºèƒ½è®­ç»ƒä»»åŠ¡ä¸­ä½¿ç”¨çš„ç®—åŠ›æ­£å‘ˆæŒ‡æ•°çº§å¢é•¿ï¼Œç›´åˆ°2018å¹´ï¼Œå…¶é€Ÿåº¦ä¸ºæ¯ 3.5 ä¸ªæœˆç¿»ä¸€å€ï¼ˆç›¸æ¯”ä¹‹ä¸‹ï¼Œæ‘©å°”å®šå¾‹æ˜¯æ¯ 18 ä¸ªæœˆç¿»å€ï¼‰ã€‚

ç„¶è€Œï¼Œè¶Šæ¥è¶Šå¤§çš„æ¨¡å‹æˆä¸ºäº†å·¥ä¸šç•Œè¿½æ§çš„äº‹ç‰©ï¼Œä»¥è‡ªç„¶è¯­è¨€æ¨¡å‹ä¸ºä¾‹ï¼Œ2018å¹´åˆ°2022å¹´ï¼Œæ¨¡å‹çš„å‚æ•°é‡ä»94Mè¿…é€Ÿå¢é•¿åˆ°äº†530Bã€‚ä¸è®ºæ˜¯åœ¨å­¦ç•Œè¿˜æ˜¯å·¥ä¸šç•Œï¼Œåˆ†å¸ƒå¼è®­ç»ƒå·²ç»æˆä¸ºè§£å†³å¤§æ¨¡å‹è®­ç»ƒçš„å”¯ä¸€é€”å¾„ã€‚ä»¥2021å¹´Microsoftå’ŒNVIDIAå…±åŒå‘å¸ƒçš„Megatron-Turingè‡ªç„¶è¯­è¨€ç”Ÿæˆæ¨¡å‹ï¼ˆMT-NLGï¼‰ä¸ºä¾‹ï¼Œå®ƒæ‹¥æœ‰5300äº¿å‚æ•°ï¼Œæ˜¯åœ¨åŸºäºNVIDIA DGX SuperPODçš„Seleneè¶…çº§è®¡ç®—æœºä¸Šå®Œæˆè®­ç»ƒçš„ï¼›è¿™ä¸ªè¶…çº§è®¡ç®—æœºé›†ç¾¤ä¸€å…±æ‹¥æœ‰560å°DGX A100æœåŠ¡å™¨ï¼Œè€Œæ¯å°æœåŠ¡å™¨éƒ½æ‹¥æœ‰å…«å¼ NVIDIA A100åŠ é€Ÿå¡ï¼Œæ˜¾å­˜ä¸º80GBã€‚

é¢å¯¹å¦‚æ­¤åºå¤§çš„æ¨¡å‹ï¼Œå¹¶è¡Œè®­ç»ƒååˆ†å¿…è¦å’Œæœ‰æ•ˆã€‚åœ¨å®é™…çš„è®­ç»ƒä¸­ï¼Œå°±åŒ…å«äº†æ•°æ®å¹¶è¡Œã€å¼ é‡å¹¶è¡Œã€æ¨¡å‹å¹¶è¡Œã€ç®¡é“å¹¶è¡Œç­‰æ–¹æ¡ˆã€‚åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªç”¨äºæ‰‹å†™ä½“è¯†åˆ«çš„å·ç§¯ç¥ç»ç½‘ç»œçš„æ¨¡å‹ï¼Œå¹¶ä¸”ä½¿ç”¨horovodè¿›è¡Œå¹¶è¡Œè®­ç»ƒã€‚

#### 7.4.1æ¨¡å‹æ„å»º

å…·ä½“çš„ç»†èŠ‚æˆ‘ä»¬å°±ä¸è¿‡å¤šä»‹ç»äº†ï¼Œæ¥ä¸‹æ¥çš„æ¨¡å‹åœ¨å¯¹MNISTæ•°æ®é›†çš„æ‰‹å†™ä½“è¯†åˆ«ä¸Šå…·æœ‰éå¸¸å¥½çš„æ•ˆæœã€‚

![](image/cnn_Pdxv4hn1-c.svg)

ç”¨ä»£ç å®ç°æ˜¯

```python
class Mnist_nn(nn.Module):
    def __init__(self):
        super(Mnist_nn, self).__init__()
        self.model = nn.Sequential(
            nn.Conv2d(in_channels=1,
                      out_channels=6,
                      padding=0,
                      kernel_size=(5, 5),
                      stride=(1, 1)),
            nn.ReLU(inplace=True),
            nn.MaxPool2d(kernel_size=2, stride=2),
            nn.Conv2d(6, 16, (5, 5), stride=(1, 1)),
            nn.ReLU(inplace=True),
            nn.MaxPool2d(kernel_size=2, stride=2),
            nn.Flatten(),
            nn.Linear(256, 128),
            nn.Linear(128, 64),
            nn.Linear(64, 10)
        )

    def forward(self, x):
        x = self.model(x)
        return x

```

æˆ‘ä»¬å°†å…¶ä¿å­˜åˆ°model.pyï¼Œç„¶ååœ¨ç›¸åŒçš„ç›®å½•ä¸‹åˆ›å»ºtrain.pyæ–‡ä»¶ï¼Œé‡Œé¢çš„å†…å®¹ä¸º

```python
def nnrun():
    for i in range(global_epoch):
        print("ç¬¬%dè½®è®­ç»ƒ" % (i + 1))
        time0 = time.time()
        for data in mnist_dataloader:
            img, tag = data
            img = img.to(device)
            tag = tag.to(device)
            outimg = mnist_nn(img)
            loss = loss_function(outimg, tag)

            optimizer.zero_grad()
            loss.backward()
            optimizer.step()
            global_train_step += 1

            if global_train_step % 1000 == 0:
                print("step=%dæ—¶ï¼ŒæŸå¤±å€¼ä¸º%f" % ((global_train_step), loss.item()))

        time1 = time.time()
        print("ç¬¬%dè½®è®­ç»ƒç”¨æ—¶%f" % ((i + 1), (time1 - time0)) + "ç§’")

        local_accuracy = 0
        accuracy_rate = 0
        with torch.no_grad():
            test_len = len(test_data)
            for test in test_dataloader:
                img, tag = test
                img = img.to(device)
                tag = tag.to(device)
                testout = mnist_nn(img)
                accuracy = (testout.argmax(1) == tag).sum()
                local_accuracy += accuracy
                accuracy_rate = local_accuracy / test_len
            print("æ­£ç¡®ç‡ä¸º%f" % accuracy_rate)

        if accuracy_rate >= 0.95:
            torch.save(mnist_nn.state_dict(), "mnist.model")
            break
```

ç„¶ååˆ›å»ºmain.pyæ–‡ä»¶ï¼Œå†…å®¹ä¸º

```python
import torch
from torch import nn
from torch.utils.data import DataLoader
import torchvision
import time
from model import Mnist_nn
from train import 
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
mnist_data = torchvision.datasets.MNIST(root="./data",
                                        train=True,
                                        transform=torchvision.transforms.ToTensor(),
                                        download=True)
test_data = torchvision.datasets.MNIST(root="./data",
                                       train=False,
                                       transform=torchvision.transforms.ToTensor(),
                                       download=True)
mnist_dataloader = DataLoader(dataset=mnist_data,
                              batch_size=128,
                              shuffle=True,
                              num_workers=0)
test_dataloader = DataLoader(dataset=test_data,
                             batch_size=128,
                             shuffle=True,
                             num_workers=0)

mnist_nn = Mnist_nn()
mnist_nn = mnist_nn.to(device)


loss_function = nn.CrossEntropyLoss()
loss_function = loss_function.to(device)

learning_rate = 1e-2
optimizer = torch.optim.SGD(mnist_nn.parameters(), lr=learning_rate)

global_train_step = 0
global_epoch = 40

nnrun()
```

ç°åœ¨è¿è¡Œmain.pyï¼Œå°±èƒ½å¤Ÿå¼€å§‹è®­ç»ƒè¿™ä¸ªæ¨¡å‹äº†ã€‚ç°åœ¨æˆ‘ä»¬åŠ å…¥horovodçš„ä¸€äº›å¿…è¦ä»£ç ç‰‡æ®µï¼Œç¨‹åºçš„ç»“æ„å¤§è‡´æ˜¯

```python
import ...
import horovod.torch as hvd

hvd.init()

datasets = ...
model = ...
optimizer = optim.SGD(model.parameters())

optimizer = hvd.DistributedOptimizer(optimizer, named_parameters=model.named_parameters())

hvd.broadcast_parameters(model.state_dict(), root_rank=0)

for i in range(epoch):
    train()
```

ç°åœ¨ï¼Œä½¿ç”¨å‘½ä»¤

```python
horovodrun -np 4 python train.py
```

å°±èƒ½å¤Ÿé€šè¿‡4ä¸ªè¿›ç¨‹æ¥è¿›è¡Œè®­ç»ƒã€‚å¦‚æœæœ‰å¤šå°è®¾å¤‡ï¼Œè¿˜èƒ½ä¸ºæ¯å°è®¾å¤‡æŒ‡å®šè¿›ç¨‹æ•°ï¼Œä¾‹å¦‚

```python
horovodrun -np 8 -H hostname1:4,hostname2:4 python train.py
```
